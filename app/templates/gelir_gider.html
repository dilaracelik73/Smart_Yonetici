{% extends "layout.html" %}
{% block content %}
<div class="mb-4 p-4 rounded-3 shadow-sm d-flex align-items-center"
     style="background: linear-gradient(90deg, #e8f5e9 0%, #ffe0b2 100%); border-left: 6px solid #4caf50;">
  <div class="me-3 d-flex align-items-center justify-content-center rounded-circle"
       style="width:60px; height:60px; background:#4caf50; color:#fff; font-size:1.6rem;">
    <i class="fas fa-chart-line"></i>
  </div>
  <div>
    <h3 class="fw-bold text-dark mb-1">Gelir - Gider Raporu</h3>
    <p class="mb-0 text-muted" style="font-size:0.95rem;">
      Toplam gelir ve giderlerinizi ayrÄ±ntÄ±lÄ± olarak gÃ¶rÃ¼ntÃ¼leyin ve analiz edin.
    </p>
  </div>
</div>


    {% if session.get("rol") == "yonetici" %}
    <div class="mb-3">
        <a href="{{ url_for('main.gider_ekle') }}" class="btn btn-success me-2">
            <i class="fas fa-plus-circle"></i> Yeni Gider Ekle
        </a>
        <a href="{{ url_for('main.gelir_ekle') }}" class="btn btn-primary">
            <i class="fas fa-plus-circle"></i> Yeni Gelir Ekle
        </a>

    </div>
    {% endif %}

    <!-- Kartlar -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-bg-success">
                <div class="card-body text-center">
                    <h5 class="card-title">Toplam Gelir</h5>
                    <p class="fs-4">{{ toplam_gelir }} â‚º</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-bg-danger">
                <div class="card-body text-center">
                    <h5 class="card-title">Toplam Gider</h5>
                    <p class="fs-4">{{ toplam_gider }} â‚º</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-bg-info">
                <div class="card-body text-center">
                    <h5 class="card-title">Net Bakiye</h5>
                    <p class="fs-4">{{ net_bakiye }} â‚º</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Grafik KartÄ± -->
    <div class="card mb-5">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">AylÄ±k Gelir - Gider GrafiÄŸi</h5>
                <div class="select is-custom" id="aySelect" data-value="">
          <button class="select-toggle" type="button" aria-haspopup="listbox" aria-expanded="false">
            <span class="select-label">TÃ¼m Aylar</span>
            <i class="fas fa-chevron-down ms-2"></i>
          </button>
          <ul class="select-menu" role="listbox">
            <li class="select-option active" data-value=""><span>ðŸ“…</span> TÃ¼m Aylar</li>
            {% for ay in aylar %}
            <li class="select-option" data-value="{{ ay }}"><span>ðŸ“…</span> {{ ay }}</li>
            {% endfor %}
          </ul>
          
        </div>

        
    
    
            </div>
            <canvas id="finansChart" height="100"></canvas>
        </div>
    </div>

    <style>

/* container */
.select.is-custom{ position:relative; min-width:220px; }
/* button */
.select-toggle{
  width:100%; background:#fff; border:1.5px solid #d0e2ff; border-radius:14px;
  padding:.65rem .9rem; display:flex; align-items:center; justify-content:space-between;
  box-shadow:0 4px 10px rgba(0,0,0,.06); transition:all .18s ease;
  font-weight:600; color:#212529;
}
.select-toggle:hover{ background:#f8f9fe; border-color:#64b5f6; box-shadow:0 6px 14px rgba(100,181,246,.18); }
.select-toggle:focus{ outline:none; border-color:#1e66ff; box-shadow:0 0 0 .2rem rgba(30,102,255,.18); }
.select-label{ display:inline-flex; align-items:center; }

/* dropdown */
.select-menu{
  position:absolute; right:0; left:0; top: calc(100% + 8px);
  background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:16px;
  box-shadow:0 18px 38px rgba(0,0,0,.16);
  padding:.5rem; margin:0; list-style:none;
  opacity:0; visibility:hidden; transform:translateY(-6px);
  transition:all .18s ease; z-index:30; max-height:320px; overflow:auto;
}
.select.is-open .select-menu{ opacity:1; visibility:visible; transform:translateY(0); }

/* option */
.select-option{
  display:flex; align-items:center; gap:.6rem;
  padding:.6rem .7rem; border-radius:12px; cursor:pointer;
  color:#212529; font-weight:600; white-space:nowrap;
}
.select-option span{ width:1.2rem; display:inline-flex; justify-content:center; }
.select-option:hover{ background:#f6f7fb; }
.select-option.active{ background:#e7f0ff; color:#1e66ff; }

/* ince kaydÄ±rma */
.select-menu::-webkit-scrollbar{ width:8px; }
.select-menu::-webkit-scrollbar-thumb{
  background:#ffd180; border-radius:8px;
}
</style>

<script>
(function(){
  const root = document.getElementById('aySelect');
  if(!root) return;
  const toggle = root.querySelector('.select-toggle');
  const label  = root.querySelector('.select-label');
  const menu   = root.querySelector('.select-menu');

  // AÃ§/kapat
  toggle.addEventListener('click', () => {
    const open = root.classList.toggle('is-open');
    toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
  });

  // SeÃ§im
  menu.addEventListener('click', e => {
    const opt = e.target.closest('.select-option');
    if(!opt) return;
    const val = (opt.dataset.value || '').toString();

    // active
    root.querySelectorAll('.select-option').forEach(o => o.classList.remove('active'));
    opt.classList.add('active');

    // label & value
    label.textContent = opt.textContent.trim();
    root.dataset.value = val;

    // kapat
    root.classList.remove('is-open');
    toggle.setAttribute('aria-expanded','false');

    // GrafiÄŸi filtrele (mevcut fonksiyonunu Ã§aÄŸÄ±rÄ±yoruz)
    if (typeof filterChartByMonth === 'function') filterChartByMonth(val);
  });

  // DÄ±ÅŸarÄ± tÄ±k kapan
  document.addEventListener('click', e => {
    if(!root.contains(e.target)) {
      root.classList.remove('is-open');
      toggle.setAttribute('aria-expanded','false');
    }
  });

  // "TÃ¼mÃ¼nÃ¼ GÃ¶ster" dÃ¼ÄŸmesi â€” hem label'Ä± hem de veriyi sÄ±fÄ±rlar
  document.getElementById('showAllBtn')?.addEventListener('click', () => {
    const first = menu.querySelector('.select-option[data-value=""]');
    if(first){
      menu.querySelectorAll('.select-option').forEach(o=>o.classList.remove('active'));
      first.classList.add('active');
      label.textContent = first.textContent.trim();
      root.dataset.value = '';
    }
    if (typeof filterChartByMonth === 'function') filterChartByMonth('');
  });
})();
</script>



    <!-- Gider Tablosu -->
    <h5 class="mt-4"><i class="fas fa-arrow-down me-2"></i> Giderler</h5>
    <table class="table table-bordered gider-table">
        <thead  >
            <tr>
                <!-- Bu kÄ±smÄ± da gÃ¼ncelle -->
                <th>Tarih</th>
                <th>Kategori</th>
                <th>AÃ§Ä±klama</th>
                <th>Tutar</th>
                {% if session.get("rol") == "yonetici" %}
                <th>Ä°ÅŸlemler</th> <!-- Sadece bir <th> yeterli -->
                {% endif %}

            </tr>
        </thead>
        <tbody>
            {% for gider in giderler %}
            <tr>
                <td>{{ gider.tarih }}</td>
                <td>{{ gider.kategori.ad }}</td>
                <td>{{ gider.aciklama }}</td>
                <td>{{ gider.tutar }} â‚º</td>
                {% if session.get("rol") == "yonetici" %}
                <td>
                    <a href="{{ url_for('main.gider_duzenle', id=gider.id) }}" class="btn btn-sm btn-warning me-1">
                        <i class="fas fa-edit"></i> DÃ¼zenle
                    </a>
                    <a href="{{ url_for('main.gider_sil', id=gider.id) }}" class="btn btn-sm btn-danger"
                        onclick="return confirm('Bu gideri silmek istediÄŸinizden emin misiniz?');">
                        <i class="fas fa-trash-alt"></i> Sil
                    </a>
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Gelir Tablosu -->
    <h5 class="mt-4"><i class="fas fa-arrow-up me-2"></i> Gelirler</h5>
    <table class="table table-bordered gelir-table">
        <thead>
            <th>Tarih</th>
            <th>AÃ§Ä±klama</th>
            <th>Tutar</th>
            {% if session.get("rol") == "yonetici" %}
            <th>Ä°ÅŸlem</th>
            {% endif %}
        </thead>
        <tbody>
            {% for gelir in gelirler %}
            <tr>
                <td>{{ gelir.tarih.strftime("%Y-%m-%d") }}</td>
                <td>{{ gelir.aciklama }}</td>
                <td>{{ gelir.tutar }} â‚º</td>
                {% if session.get("rol") == "yonetici" %}
                <td>
                    <a href="{{ url_for('main.gelir_sil', id=gelir.id) }}" class="btn btn-sm btn-danger"
                        onclick="return confirm('Bu geliri silmek istediÄŸinizden emin misiniz?');">
                        <i class="fas fa-trash-alt"></i> Sil
                    </a>
                    <a href="{{ url_for('main.gelir_duzenle', id=gelir.id) }}" class="btn btn-sm btn-warning">
                        <i class="fas fa-edit"></i> DÃ¼zenle
                    </a>

                </td>
                {% endif %}
            </tr>

            {% endfor %}
        </tbody>
    </table>
</div>
<style>
/* Gider tablosu */
.gider-table thead th {
    background-color: #d71a1a !important;
    color: black !important;
}

/* Gelir tablosu */
.gelir-table thead th {
    background-color: #2e7d32 !important;
    color: black !important;
}</style>
    
    

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const allLabels = {{ aylar | tojson }};
  const allGelir  = {{ gelir_seri | tojson }};
  const allGider  = {{ gider_seri | tojson }};

  const ctx = document.getElementById('finansChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: allLabels,
      datasets: [
        {
          label: 'Gelir',
          data: allGelir,
          borderColor: 'green',
          backgroundColor: 'rgba(0, 128, 0, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4,
          pointRadius: 4,
          pointBackgroundColor: 'green'
        },
        {
          label: 'Gider',
          data: allGider,
          borderColor: 'red',
          backgroundColor: 'rgba(255, 0, 0, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4,
          pointRadius: 4,
          pointBackgroundColor: 'red'
        }
      ]
    },
    options: {
      plugins: { legend: { position: 'bottom' } },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'Tutar (â‚º)' } },
        x: { title: { display: true, text: 'Aylar' } }
      }
    }
  });

  function filterChartByMonth(selectedMonth) {
    if (selectedMonth) {
      const idx = allLabels.indexOf(selectedMonth);
      if (idx !== -1) {
        chart.data.labels = [allLabels[idx]];
        chart.data.datasets[0].data = [allGelir[idx]];
        chart.data.datasets[1].data = [allGider[idx]];
      }
    } else {
      chart.data.labels = allLabels.slice();
      chart.data.datasets[0].data = allGelir.slice();
      chart.data.datasets[1].data = allGider.slice();
    }
    chart.update();
  }
</script>
{% endblock %}